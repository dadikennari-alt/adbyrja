<!DOCTYPE html>
<html lang="is">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tal√¶fing FB - Morguninn minn (Blanda√∞ efni)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  body { font-family: 'Segoe UI', sans-serif; background-color: #f0f4f8; text-align: center; padding: 10px; margin: 0; }
  /* A√∞al kassinn utan um √¶finguna */
  .card { background: white; max-width: 500px; margin: 20px auto; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 8px solid #004a99; }
  
  /* Framvindustika efst (Heildar√°rangur) */
  .overall-progress { margin-bottom: 20px; font-size: 0.9em; color: #555; }
  .progress-container { width: 100%; background: #e0e0e0; height: 10px; border-radius: 5px; margin-top: 5px; }
  .progress-fill { height: 100%; width: 0%; background: #004a99; border-radius: 5px; transition: width 0.5s ease; }
  
  h2 { color: #2c3e50; margin-top: 0; }
  .counter { color: #888; font-size: 0.9em; margin-bottom: 10px; display: block; font-weight: bold;}
  
  /* Sv√¶√∞i√∞ fyrir mi√∞ilinn (mynd e√∞a myndband) */
  .media-container { width: 100%; height: 280px; background-color: #000; border-radius: 10px; margin-bottom: 20px; overflow: hidden; display: flex; align-items: center; justify-content: center; position: relative; }
  /* St√≠ll fyrir lj√≥smyndir */
  .exercise-img { width: 100%; height: 100%; object-fit: cover; }
  /* St√≠ll fyrir YouTube iframe */
  .video-frame { width: 100%; height: 100%; border: none; }

  /* Boxi√∞ utan um textann sem √° a√∞ lesa */
  .phrase-box { background-color: #fdfdfe; border: 2px solid #e1e4e8; border-radius: 12px; padding: 15px; margin-bottom: 15px; min-height: 30px; display: flex; align-items: center; justify-content: center;}
  .target-text { font-size: 1.3em; color: #2c3e50; font-weight: bold; }
  
  /* Uppt√∂kuhnappurinn */
  .record-btn { background-color: #27ae60; color: white; border: none; padding: 15px 30px; font-size: 1.1em; border-radius: 50px; cursor: pointer; transition: 0.2s; width: 100%; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  .record-btn:hover { background-color: #219150; }
  .record-btn.recording { background-color: #ff5252; animation: pulse 1.5s infinite; }
  @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 82, 82, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 82, 82, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 82, 82, 0); } }
  
  /* Ni√∞urst√∂√∞usv√¶√∞i√∞ */
  .result-area { min-height: 110px; margin-top: 10px; background: #f9f9f9; padding: 10px; border-radius: 10px;}
  .score-bar-bg { width: 100%; background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden; margin: 10px 0; }
  .score-bar-fill { height: 100%; width: 0%; background: #27ae60; transition: width 0.6s ease; }
  .user-said { font-size: 1.1em; color: #2c3e50; margin-top: 5px; font-style: italic; font-weight: bold; }
  
  /* Stj√≥rntakkar ne√∞st (Fyrri/N√¶sta) og litla l√≥g√≥i√∞ */
  .nav-row { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
  .nav-btn { background-color: #eceff1; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; color: #555; font-weight: bold; font-size: 1em;}
  .nav-btn:hover { background-color: #d0d3d4; }
  .small-logo { height: 40px; width: auto; border-radius: 4px; }

  /* Sk√≠rteini (Modal gluggi) */
  #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; flex-direction: column; }
  #cert-wrap { background: white; padding: 30px; border: 10px double #004a99; width: 90%; max-width: 500px; text-align: center; box-sizing: border-box; border-radius: 10px;}
  .cert-logo { width: 80px; margin-bottom: 10px; }
  .student-name-input { font-size: 1.5em; border: none; border-bottom: 2px solid #004a99; text-align: center; width: 80%; margin: 15px 0; outline: none; background: #f4f4f4; padding: 5px;}
  .action-btns { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
  .save-btn, .close-btn { border: none; padding: 12px 24px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 1em;}
  .save-btn { background: #004a99; color: white; }
  .close-btn { background: #95a5a6; color: white; }
</style>
</head>
<body>

<div class="card">
    <div class="overall-progress">
        √Årangur: <span id="completed-count">0</span> / 10
        <div class="progress-container"><div id="overall-fill" class="progress-fill"></div></div>
    </div>

    <h2>Morgunverk</h2>
    <span class="counter" id="counter">1 / 10</span>

    <div class="media-container" id="media-content">
        </div>

    <div class="phrase-box"><span class="target-text" id="target">Hle√∞ inn...</span></div>

    <button class="record-btn" id="record-btn">üéôÔ∏è √ùttu og lestu</button>

    <div class="result-area">
        <div class="score-bar-bg"><div id="score-fill" class="score-bar-fill"></div></div>
        <div id="accuracy" style="font-weight:bold; color:#004a99;">N√°kv√¶mni: 0%</div>
        <div class="user-said" id="user-input"></div>
    </div>

    <div class="nav-row">
        <button class="nav-btn" onclick="move(-1)">‚¨Ö Fyrri</button>
        <img src="https://geymd.arnastofnun.is/ismus/data/e534627e-82ae-497a-8a52-22e8170a9f5a/filename.jpg" alt="FB Logo" class="small-logo">
        <button class="nav-btn" onclick="move(1)">N√¶sta ‚û°</button>
    </div>
</div>

<div id="modal-overlay">
    <div id="cert-wrap">
        <img src="https://geymd.arnastofnun.is/ismus/data/e534627e-82ae-497a-8a52-22e8170a9f5a/filename.jpg" alt="Logo" class="cert-logo">
        <h1 style="font-family: serif; font-size: 2.5em; margin: 10px 0; color: #004a99;">SK√çRTEINI</h1>
        <p>√ûetta sta√∞festir a√∞:</p>
        <input type="text" id="student-name" class="student-name-input" placeholder="Skrifa√∞u nafni√∞ √æitt h√©r">
        <p>hefur loki√∞ tal√¶fingunni:</p>
        <h3 style="color: #333; margin: 10px 0;">Morgunverk</h3>
        <p id="cert-date" style="font-size: 0.9em; color: #777;"></p>
        <div style="font-size: 2em; margin-top: 10px;">üèÜ</div>
    </div>
    <div class="action-btns">
        <button class="save-btn" onclick="downloadCert()">üíæ Vista sem mynd</button>
        <button class="close-btn" onclick="closeModal()">Loka</button>
    </div>
</div>

<script>
// G√ñGNIN: 5 YouTube myndb√∂nd + 5 Lj√≥smyndir
// ATH: YouTube hlekkir ver√∞a a√∞ hafa ?autoplay=1&mute=1 til a√∞ spilast sj√°lfkrafa √≠ v√∂frum.
const exerciseData = [
    // --- 5 MYNDB√ñND (YouTube) ---
    { text: "√âg vakna.", url: "https://www.youtube.com/embed/eZ1Q6a5q8pU?autoplay=1&mute=1&controls=0" },
    { text: "√âg fer √° f√¶tur.", url: "https://www.youtube.com/embed/Fj5t0h6_06Q?autoplay=1&mute=1&controls=0" },
    { text: "√âg fer √≠ sturtu.", url: "https://www.youtube.com/embed/E91gz18XjYk?autoplay=1&mute=1&controls=0" }, // (Generic footage substitute)
    { text: "√âg bursta tennur.", url: "https://www.youtube.com/embed/0O9F80g0A0A?autoplay=1&mute=1&controls=0" }, // (Generic footage substitute)
    { text: "√âg grei√∞i h√°ri√∞.", url: "https://www.youtube.com/embed/Z_q6bSjYk0E?autoplay=1&mute=1&controls=0" }, // (Generic footage substitute)

    // --- 5 LJ√ìSMYNDIR (Unsplash) ---
    { text: "√âg kl√¶√∞i mig.", url: "https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?w=600&auto=format&fit=crop&q=60" },
    { text: "√âg bor√∞a morgunmat.", url: "https://images.unsplash.com/photo-1493770348161-369560ae357d?w=600&auto=format&fit=crop&q=60" },
    { text: "√âg drekk vatn.", url: "https://images.unsplash.com/photo-1509042239860-f550ce710b93?w=600&auto=format&fit=crop&q=60" },
    { text: "√âg tek t√∂skuna m√≠na.", url: "https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=600&auto=format&fit=crop&q=60" },
    { text: "√âg fer √≠ sk√≥lann.", url: "https://images.unsplash.com/photo-1523050854058-8df90110c9f1?w=600&auto=format&fit=crop&q=60" }
];

let currentIndex = 0;
// Athugum hvort vafrinn sty√∞ur talgreiningu
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const recognition = SpeechRecognition ? new SpeechRecognition() : null;

if (recognition) {
    recognition.lang = 'is-IS';
    recognition.continuous = false;
    recognition.interimResults = false;
} else {
    alert("√ûessi vafri sty√∞ur ekki talgreiningu. Nota√∞u Chrome e√∞a Edge √° t√∂lvu.");
}

// √ûegar s√≠√∞an hle√∞st inn
window.onload = () => { 
    localStorage.clear(); // Hreinsum gamlan √°rangur √≠ byrjun
    updateUI(); 
};

// Uppf√¶ra √∫tliti√∞ fyrir n√Ωja setningu og n√Ωjan mi√∞il
function updateUI() {
    const curr = exerciseData[currentIndex];
    const mediaBox = document.getElementById('media-content');

    // Uppf√¶ra texta og teljara
    document.getElementById('target').innerText = curr.text;
    document.getElementById('counter').innerText = `${currentIndex + 1} / ${exerciseData.length}`;
    
    // Athuga hvort √æetta er YouTube hlekkur e√∞a venjuleg mynd
    if (curr.url.includes('youtube.com')) {
        // Ef YouTube: B√∫a til iframe
        mediaBox.innerHTML = `<iframe class="video-frame" src="${curr.url}" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
    } else {
        // Ef mynd: B√∫a til img
        mediaBox.innerHTML = `<img id="current-image" class="exercise-img" src="${curr.url}" alt="Mynd">`;
    }
    
    // N√∫llstilla ni√∞urst√∂√∞ur
    document.getElementById('user-input').innerText = "";
    document.getElementById('accuracy').innerText = "N√°kv√¶mni: 0%";
    document.getElementById('score-fill').style.width = "0%";
}

// Reikna heildar√°rangur
function calculateProgress() {
    let done = 0;
    for(let i=0; i<exerciseData.length; i++) {
        if((localStorage.getItem('score_'+i) || 0) >= 80) done++;
    }
    document.getElementById('completed-count').innerText = done;
    document.getElementById('overall-fill').style.width = (done/exerciseData.length)*100 + "%";
    
    // Ef allt er b√∫i√∞, s√Ωna sk√≠rteini
    if(done === exerciseData.length) {
        document.getElementById('cert-date').innerText = new Date().toLocaleDateString('is-IS');
        setTimeout(() => {
            document.getElementById('modal-overlay').style.display = 'flex';
        }, 500);
    }
}

// Fara √°fram/aftur√°bak
function move(dir) {
    currentIndex += dir;
    if(currentIndex < 0) currentIndex = 0;
    if(currentIndex >= exerciseData.length) currentIndex = exerciseData.length - 1;
    updateUI();
}

// Snyrta textann fr√° notanda
function formatUserSpeech(text) {
    if (!text) return "";
    let formatted = text.trim();
    formatted = formatted.charAt(0).toUpperCase() + formatted.slice(1);
    if (!formatted.endsWith('.') && !formatted.endsWith('!')) formatted += ".";
    return formatted;
}

// Uppt√∂kuhnappur virkni
const recBtn = document.getElementById('record-btn');
recBtn.onclick = () => { 
    if (!recognition) return alert("Talgreining ekki studd.");
    try {
        recognition.start(); 
        recBtn.classList.add('recording'); 
        recBtn.innerText = "Hlusta..."; 
    } catch(e) { console.log("Hlj√≥√∞nemi √æegar √≠ gangi e√∞a villa."); }
};

// √ûegar ni√∞ursta√∞a kemur √∫r talgreiningu
if (recognition) {
    recognition.onresult = (e) => {
        recBtn.classList.remove('recording'); 
        recBtn.innerText = "üéôÔ∏è √ùttu og lestu";
        
        const rawSpeech = e.results[0][0].transcript;
        const formattedSpeech = formatUserSpeech(rawSpeech);
        const target = exerciseData[currentIndex].text;
        
        // Einfaldur samanbur√∞ur
        const score = compare(rawSpeech, target);
        
        document.getElementById('user-input').innerText = `‚Äû${formattedSpeech}‚Äú`;
        document.getElementById('accuracy').innerText = `N√°kv√¶mni: ${score}%`;
        document.getElementById('score-fill').style.width = score + "%";
        
        // Vista ef √°rangur er g√≥√∞ur (yfir 80%)
        if(score >= 80) { 
            localStorage.setItem('score_'+currentIndex, score); 
            calculateProgress(); 
        }
    };

    recognition.onend = () => {
        recBtn.classList.remove('recording');
        recBtn.innerText = "üéôÔ∏è √ùttu og lestu";
    };
    
    recognition.onerror = (event) => {
        recBtn.classList.remove('recording');
        recBtn.innerText = "üéôÔ∏è √ùttu og lestu";
        console.error("Talgreiningarvilla:", event.error);
    };
}

// Samanbur√∞arfall (einfalda√∞)
function compare(s1, s2) {
    const clean = s => s.toLowerCase().replace(/[.,/#!$%^&*;:{}=\-_`~()]/g,"").trim();
    const w1 = clean(s1).split(/\s+/); 
    const w2 = clean(s2).split(/\s+/);
    let m = 0; 
    w1.forEach(w => { if(w2.includes(w)) m++; });
    // Reikna pr√≥sentu byggt √° lengsta setningunni
    return Math.round((m / Math.max(w1.length, w2.length)) * 100) || 0;
}

// Vista sk√≠rteini sem mynd
async function downloadCert() {
    const nameInput = document.getElementById('student-name');
    const name = nameInput.value;
    if(!name) return alert("Vinsamlegast skrifa√∞u nafn!");
    
    const wrap = document.getElementById('cert-wrap');
    const nameText = document.createElement('h2');
    nameText.innerText = name;
    nameText.style.color = "#004a99";
    nameInput.style.display = "none";
    nameInput.parentNode.insertBefore(nameText, nameInput);
    
    try {
        const canvas = await html2canvas(wrap, { useCORS: true, scale: 2 });
        const link = document.createElement('a');
        link.download = `Skirteini-${name.replace(/\s+/g, '_')}.png`; 
        link.href = canvas.toDataURL('image/png'); 
        link.click();
    } catch (err) {
        console.error("Villa vi√∞ a√∞ vista sk√≠rteini:", err);
        alert("Gat ekki vista√∞ sk√≠rteini√∞. Athuga√∞u vafrann.");
    } finally {
        nameInput.style.display = "inline-block"; 
        nameText.remove();
    }
}

function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
</script>
</body>
</html>
